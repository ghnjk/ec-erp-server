import{i as P,r as f,M as v,_ as ue,d as te,n as ce,a as d,b,c as ae,h as M,w as u,e as t,u as N,g as E,f as K,t as S,j as W,k as Z,p as ne,q as le,o as _e}from"./index.8c350534.js";import{s as de}from"./warehouseApis.e41f746f.js";import{a as pe,s as ge,b as ee,l as oe}from"./skuUtil.e53025be.js";import"./supplierApis.af8f22bd.js";const me=n=>P.post("/erp_api/sale/save_sku_sale_price",n),ke=n=>P.post("/erp_api/sale/search_sku_sale_price",n),fe=n=>P.post("/erp_api/sale/create_sale_order",n),ve=n=>P.post("/erp_api/sale/update_sale_order",n),Ee=n=>P.post("/erp_api/sale/delete_sale_order",n),Fe=n=>P.post("/erp_api/sale/submit_sale_order",n),ye=n=>P.post("/erp_api/sale/search_sale_order",n),L=f(new Map);async function he(){L.value=new Map;const n=1e4;let i=1,l=!0;try{for(;l;){const o=await de({current_page:i,page_size:n,search_sku:""});o.list&&o.list.length>0&&o.list.forEach(p=>{L.value.set(p.sku,p)}),l=o.list&&o.list.length===n,i++}console.log(`\u6210\u529F\u52A0\u8F7D ${L.value.size} \u6761SKU\u62E3\u8D27\u5907\u6CE8\u4FE1\u606F`)}catch(s){console.error("\u52A0\u8F7DSKU\u62E3\u8D27\u5907\u6CE8\u5931\u8D25:",s),await v.error(`\u52A0\u8F7DSKU\u62E3\u8D27\u5907\u6CE8\u5F02\u5E38: ${s}`)}}function X(n,i){const l=L.value.get(n);if(!l)return{picking_count:i,picking_unit:"pcs",display_text:`${i} pcs`};if(l.support_pkg_picking&&l.pkg_picking_unit>0){const o=Math.floor(i/l.pkg_picking_unit),p=i%l.pkg_picking_unit;if(p===0)return{picking_count:o,picking_unit:l.pkg_picking_unit_name,display_text:`${o} ${l.pkg_picking_unit_name}`};if(o>0)return{picking_count:o,picking_unit:l.pkg_picking_unit_name,display_text:`${o} ${l.pkg_picking_unit_name} + ${p} ${l.picking_unit_name}`}}const s=i/l.picking_unit;return{picking_count:s,picking_unit:l.picking_unit_name,display_text:`${s} ${l.picking_unit_name}`}}function Be(n){if(!n||n.length===0)return"-";const i=new Map;n.forEach(s=>{const o=s.sku_group||"\u672A\u5206\u7EC4",p=s.quantity||0,h=s.total_amount||(s.unit_price||0)*p;if(i.has(o)){const F=i.get(o);i.set(o,{totalQuantity:F.totalQuantity+p,totalAmount:F.totalAmount+h,firstSku:F.firstSku})}else i.set(o,{totalQuantity:p,totalAmount:h,firstSku:s.sku})});const l=[];return i.forEach((s,o)=>{const p=X(s.firstSku,s.totalQuantity);l.push(`${o}: ${p.display_text} = ${s.totalAmount.toFixed(2)}`)}),l.join(`
`)}const V=f(new Map),J=f(!1);let I=null;async function se(){return I||(J.value?Promise.resolve():(I=(async()=>{V.value=new Map,J.value=!1;const n=1e4;let i=1,l=!0;try{for(;l;){const o=await ke({current_page:i,page_size:n,sku:""}),p=o.list||o.records||[];p.length>0&&p.forEach(h=>{V.value.set(h.sku,h.unit_price)}),l=p.length===n,i++}console.log(`\u6210\u529F\u52A0\u8F7D ${V.value.size} \u6761SKU\u9500\u552E\u4EF7\u683C\u4FE1\u606F`),J.value=!0}catch(s){console.error("\u52A0\u8F7DSKU\u9500\u552E\u4EF7\u683C\u5931\u8D25:",s),await v.error(`\u52A0\u8F7DSKU\u9500\u552E\u4EF7\u683C\u5F02\u5E38: ${s}`)}finally{I=null}})(),I))}function De(n){return V.value.get(n)||0}async function Se(n){const i=[];for(const l of n){const s=V.value.get(l.sku),o=l.unit_price;(s===void 0||s!==o)&&(i.push(me({sku:l.sku,unit_price:o})),V.value.set(l.sku,o))}i.length>0&&(await Promise.all(i),console.log(`\u6210\u529F\u66F4\u65B0 ${i.length} \u6761SKU\u9500\u552E\u4EF7\u683C`))}const re=n=>(ne("data-v-ec2d381a"),n=n(),le(),n),we={style:{"text-align":"right"}},Ce=re(()=>K("br",null,null,-1)),Ae={class:"table-container"},be=re(()=>K("br",null,null,-1)),xe={name:"EditSaleOrderDialog"},$e=te({...xe,emits:["onOrderChange"],setup(n,{expose:i,emit:l}){const s=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}),o=f(!1),p=f(!0),h=f(null),F=f(""),D=f(""),B=f(""),g=f([]),x=f(0),w=ce(()=>{if(!D.value)return[];const a=pe.value.get(D.value);return a?a.map(e=>({label:`${e.sku} - ${e.sku_name}`,value:e.sku})):[]}),R=[{width:100,colKey:"sku_group",title:"SKU\u5206\u7EC4",align:"center"},{width:120,colKey:"sku_name",title:"\u5546\u54C1\u540D",align:"center"},{width:150,colKey:"sku",title:"\u5546\u54C1SKU",align:"center"},{width:100,colKey:"quantity",title:"\u6570\u91CF",align:"center",edit:{component:Z,props:{autofocus:!0,min:1},validateTrigger:"change",abortEditOnEvent:["onEnter","onBlur"],onEdited:a=>{g.value.splice(a.rowIndex,1,a.newRowData),Y(a.rowIndex),$()},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!0}},{width:150,colKey:"picking_info",title:"\u62E3\u8D27\u4FE1\u606F",align:"center"},{width:100,colKey:"unit_price",title:"\u5355\u4EF7",align:"center",edit:{component:Z,props:{autofocus:!0,min:.01,step:.01},validateTrigger:"change",abortEditOnEvent:["onEnter","onBlur"],onEdited:a=>{g.value.splice(a.rowIndex,1,a.newRowData),$()},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!1}},{width:120,colKey:"total_amount",title:"\u603B\u4EF7",align:"center"},{width:80,colKey:"operation",title:"\u64CD\u4F5C",align:"center"}],Y=a=>{const e=g.value[a],_=X(e.sku,e.quantity);e.picking_display_text=_.display_text,e.total_amount=e.unit_price*e.quantity},j=()=>{if(!B.value){v.warning("\u8BF7\u5148\u9009\u62E9SKU");return}if(g.value.find(C=>C.sku===B.value)){v.warning("\u8BE5SKU\u5DF2\u6DFB\u52A0");return}const e=ee.value.get(B.value);if(!e){v.error("SKU\u4FE1\u606F\u4E0D\u5B58\u5728");return}const _=De(B.value),k={idx:g.value.length+1,sku:e.sku,sku_group:e.sku_group,sku_name:e.sku_name,erp_sku_image_url:e.erp_sku_image_url,quantity:1,unit_price:_||0,total_amount:_||0,picking_display_text:""};g.value.push(k),Y(g.value.length-1),$(),B.value=""},G=a=>{const e=g.value.findIndex(_=>_.idx===a.idx);e!==-1&&(g.value.splice(e,1),g.value.forEach((_,k)=>{_.idx=k+1}),$())},$=()=>{x.value=0,g.value.forEach(a=>{a.total_amount=a.quantity*a.unit_price,x.value+=a.total_amount})},y=async a=>{await oe(),await se(),a?(p.value=!1,h.value=a,F.value=a.order_date,g.value=[],a.sale_sku_list.forEach((e,_)=>{const k=ee.value.get(e.sku),C=X(e.sku,e.quantity);g.value.push({idx:_+1,sku:e.sku,sku_group:e.sku_group||(k==null?void 0:k.sku_group)||"",sku_name:e.sku_name||(k==null?void 0:k.sku_name)||"",erp_sku_image_url:e.erp_sku_image_url||(k==null?void 0:k.erp_sku_image_url)||"",quantity:e.quantity,unit_price:e.unit_price,total_amount:e.total_amount||e.unit_price*e.quantity,picking_display_text:C.display_text})})):(p.value=!0,h.value=null,F.value=new Date().toISOString().slice(0,10),g.value=[]),D.value="",B.value="",$(),o.value=!0},c=()=>g.value.map(a=>({sku:a.sku,sku_group:a.sku_group,sku_name:a.sku_name,erp_sku_image_url:a.erp_sku_image_url,quantity:a.quantity,unit_price:a.unit_price,total_amount:a.total_amount})),z=async()=>{if(!F.value){v.error("\u8BF7\u9009\u62E9\u8BA2\u5355\u65E5\u671F");return}if(g.value.length===0){v.error("\u8BF7\u81F3\u5C11\u6DFB\u52A0\u4E00\u4E2A\u5546\u54C1");return}if(g.value.filter(e=>!e.unit_price||e.unit_price<=0).length>0){v.error("\u5B58\u5728\u672A\u8BBE\u7F6E\u5355\u4EF7\u7684\u5546\u54C1\uFF0C\u8BF7\u68C0\u67E5");return}try{await Se(g.value);const e=c();if(p.value){const _={order_date:F.value,sale_sku_list:e};console.log("\u521B\u5EFA\u9500\u552E\u8BA2\u5355:",_),await fe(_),v.success("\u521B\u5EFA\u9500\u552E\u8BA2\u5355\u6210\u529F")}else{const _={order_id:h.value.order_id,order_date:F.value,sale_sku_list:e};console.log("\u66F4\u65B0\u9500\u552E\u8BA2\u5355:",_),await ve(_),v.success("\u66F4\u65B0\u9500\u552E\u8BA2\u5355\u6210\u529F")}o.value=!1,l("onOrderChange")}catch(e){console.error("\u4FDD\u5B58\u9500\u552E\u8BA2\u5355\u5931\u8D25:",e),v.error(`\u4FDD\u5B58\u9500\u552E\u8BA2\u5355\u5F02\u5E38: ${e}`)}};return i({popupDialog:y}),(a,e)=>{const _=d("t-date-picker"),k=d("t-form-item"),C=d("t-form"),A=d("t-col"),q=d("t-row"),U=d("t-select"),O=d("t-button"),Q=d("t-image"),T=d("t-space"),H=d("t-table"),r=d("t-dialog");return b(),ae("div",null,[o.value?(b(),M(r,{key:0,visible:o.value,"onUpdate:visible":e[4]||(e[4]=m=>o.value=m),"cancel-btn":null,"close-on-esc-keydown":!1,"close-on-overlay-click":!1,"confirm-btn":null,header:p.value?"\u65B0\u5EFA\u9500\u552E\u8BA2\u5355":"\u7F16\u8F91\u9500\u552E\u8BA2\u5355","show-overlay":"",width:"85%"},{default:u(()=>[t(q,null,{default:u(()=>[t(A,{span:10},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(k,{label:"\u8BA2\u5355\u65E5\u671F:",name:"orderDate",required:""},{default:u(()=>[t(_,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=m=>F.value=m),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u9009\u62E9\u8BA2\u5355\u65E5\u671F",style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(q,null,{default:u(()=>[t(A,{span:8},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(k,{label:"SKU\u5206\u7EC4:",name:"skuGroupName"},{default:u(()=>[t(U,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=m=>D.value=m),options:N(ge),filterable:"",placeholder:"-\u8BF7\u9009\u62E9SKU\u5206\u7EC4-",style:{width:"200px"}},null,8,["modelValue","options"])]),_:1}),t(k,{label:"SKU:",name:"selectedSku"},{default:u(()=>[t(U,{modelValue:B.value,"onUpdate:modelValue":e[2]||(e[2]=m=>B.value=m),options:N(w),filterable:"",placeholder:"-\u8BF7\u9009\u62E9SKU-",style:{width:"250px"}},null,8,["modelValue","options"])]),_:1})]),_:1})]),_:1}),t(A,{span:3},{default:u(()=>[t(O,{theme:"default",onClick:j},{default:u(()=>[E("\u6DFB\u52A0SKU")]),_:1})]),_:1}),t(A,{span:7},{default:u(()=>[K("h3",we,"\u603B\u91D1\u989D\uFF1A"+S(N(s).format(x.value)),1)]),_:1})]),_:1}),Ce,K("div",Ae,[t(H,{bordered:!0,columns:R,data:g.value,"lazy-load":"",resizable:"","row-key":"idx","table-layout":"fixed"},{sku:u(({row:m})=>[t(T,null,{default:u(()=>[t(Q,{src:m.erp_sku_image_url,style:{width:"30px",height:"30px"}},null,8,["src"]),E(" "+S(m.sku),1)]),_:2},1024)]),picking_info:u(({row:m})=>[E(S(m.picking_display_text),1)]),total_amount:u(({row:m})=>[E(S(N(s).format(m.total_amount)),1)]),operation:u(({row:m})=>[t(O,{size:"small",theme:"danger",variant:"text",onClick:ze=>G(m)},{default:u(()=>[E("\u5220\u9664")]),_:2},1032,["onClick"])]),_:1},8,["data"]),be,t(q,null,{default:u(()=>[t(A,{span:9}),t(A,{span:3},{default:u(()=>[t(T,null,{default:u(()=>[t(O,{style:{float:"right"},theme:"default",onClick:e[3]||(e[3]=m=>o.value=!1)},{default:u(()=>[E("\u53D6\u6D88")]),_:1}),t(O,{style:{float:"right"},theme:"primary",onClick:z},{default:u(()=>[E("\u4FDD\u5B58")]),_:1})]),_:1})]),_:1})]),_:1})])]),_:1},8,["visible","header"])):W("v-if",!0)])}}});var ie=ue($e,[["__scopeId","data-v-ec2d381a"],["__file","/Users/jkguo/workspace/ec-erp-static/src/pages/sales/components/editSaleOrderDialog.vue"]]);const Oe=n=>(ne("data-v-135960ee"),n=n(),le(),n),Ke=Oe(()=>K("br",null,null,-1)),Pe={class:"table-container"},Ue={style:{"white-space":"pre-wrap"}},Me={name:"SaleOrderList",components:{EditSaleOrderDialog:ie}},Ve=te({...Me,setup(n){const i=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}),l=f({status:"",begin_date:"",end_date:""}),s=[{label:"\u5F85\u540C\u6B65",value:"\u5F85\u540C\u6B65"},{label:"\u5DF2\u540C\u6B65",value:"\u5DF2\u540C\u6B65"}],o=[{width:80,colKey:"order_id",title:"\u8BA2\u5355ID",align:"center"},{width:150,colKey:"order_date",title:"\u8BA2\u5355\u65E5\u671F",align:"center"},{width:250,colKey:"sku_order_summary",title:"\u8BA2\u5355\u6458\u8981",align:"left"},{width:120,colKey:"total_amount",title:"\u603B\u91D1\u989D",align:"center"},{width:100,colKey:"status",title:"\u72B6\u6001",align:"center"},{width:150,colKey:"modify_time",title:"\u4FEE\u6539\u65F6\u95F4",align:"center"},{width:180,colKey:"op",title:"\u64CD\u4F5C",align:"center",fixed:"right"}],p=f([]),h=f(!1),F=f(1),D=f(20),B=[10,20,50,100],g=f(0),x=f(),w=async()=>{h.value=!0;try{const y={status:l.value.status||void 0,begin_date:l.value.begin_date||void 0,end_date:l.value.end_date||void 0,current_page:F.value,page_size:D.value},c=await ye(y),z=c.list||c.records||[];p.value=z.map(a=>({...a,sku_order_summary:Be(a.sale_sku_list)})),g.value=c.total||0}catch(y){console.error("\u67E5\u8BE2\u9500\u552E\u8BA2\u5355\u5931\u8D25:",y),v.error(`\u67E5\u8BE2\u9500\u552E\u8BA2\u5355\u5F02\u5E38: ${y}`)}finally{h.value=!1}},R=()=>{w()},Y=()=>{x.value.popupDialog(null)},j=y=>{x.value.popupDialog(y)},G=async y=>{try{await Fe({order_id:y.order_id}),v.success("\u63D0\u4EA4\u8BA2\u5355\u6210\u529F"),await w()}catch(c){console.error("\u63D0\u4EA4\u8BA2\u5355\u5931\u8D25:",c),v.error(`\u63D0\u4EA4\u8BA2\u5355\u5F02\u5E38: ${c}`)}},$=async y=>{try{await Ee({order_id:y.order_id}),v.success("\u5220\u9664\u8BA2\u5355\u6210\u529F"),await w()}catch(c){console.error("\u5220\u9664\u8BA2\u5355\u5931\u8D25:",c),v.error(`\u5220\u9664\u8BA2\u5355\u5F02\u5E38: ${c}`)}};return _e(async()=>{Promise.all([oe(),se(),he()]).catch(y=>{console.error("\u9884\u52A0\u8F7D\u57FA\u7840\u6570\u636E\u5931\u8D25:",y)}),await w()}),(y,c)=>{const z=d("t-select"),a=d("t-form-item"),e=d("t-date-picker"),_=d("t-button"),k=d("t-space"),C=d("t-form"),A=d("t-col"),q=d("t-row"),U=d("t-tag"),O=d("t-popconfirm"),Q=d("t-table"),T=d("t-pagination"),H=d("t-card");return b(),ae("div",null,[t(H,null,{default:u(()=>[t(q,null,{default:u(()=>[t(A,{span:12},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(a,{label:"\u8BA2\u5355\u72B6\u6001:",name:"status"},{default:u(()=>[t(z,{modelValue:l.value.status,"onUpdate:modelValue":c[0]||(c[0]=r=>l.value.status=r),options:s,clearable:"",placeholder:"\u8BF7\u9009\u62E9\u72B6\u6001",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(a,{label:"\u5F00\u59CB\u65E5\u671F:",name:"begin_date"},{default:u(()=>[t(e,{modelValue:l.value.begin_date,"onUpdate:modelValue":c[1]||(c[1]=r=>l.value.begin_date=r),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u5F00\u59CB\u65E5\u671F",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(a,{label:"\u7ED3\u675F\u65E5\u671F:",name:"end_date"},{default:u(()=>[t(e,{modelValue:l.value.end_date,"onUpdate:modelValue":c[2]||(c[2]=r=>l.value.end_date=r),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u7ED3\u675F\u65E5\u671F",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(a,null,{default:u(()=>[t(k,{size:"small",style:{"align-items":"center","margin-left":"30px"}},{default:u(()=>[t(_,{theme:"primary",onClick:w},{default:u(()=>[E("\u67E5\u8BE2")]),_:1}),t(_,{theme:"success",onClick:Y},{default:u(()=>[E("\u65B0\u5EFA\u8BA2\u5355")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),Ke,K("div",Pe,[t(Q,{columns:o,data:p.value,loading:h.value,bordered:"",hover:"","row-key":"order_id",stripe:""},{sku_order_summary:u(({row:r})=>[K("div",Ue,S(r.sku_order_summary),1)]),total_amount:u(({row:r})=>[E(S(N(i).format(r.total_amount)),1)]),status:u(({row:r})=>[r.status==="\u5F85\u540C\u6B65"?(b(),M(U,{key:0,theme:"warning"},{default:u(()=>[E(S(r.status),1)]),_:2},1024)):r.status==="\u5DF2\u540C\u6B65"?(b(),M(U,{key:1,theme:"success"},{default:u(()=>[E(S(r.status),1)]),_:2},1024)):(b(),M(U,{key:2},{default:u(()=>[E(S(r.status),1)]),_:2},1024))]),op:u(({row:r})=>[r.status==="\u5F85\u540C\u6B65"?(b(),M(_,{key:0,size:"small",theme:"primary",variant:"text",onClick:m=>j(r)},{default:u(()=>[E(" \u7F16\u8F91 ")]),_:2},1032,["onClick"])):W("v-if",!0),r.status==="\u5F85\u540C\u6B65"?(b(),M(O,{key:1,content:"\u786E\u8BA4\u63D0\u4EA4\u8BE5\u8BA2\u5355\u5417\uFF1F\u63D0\u4EA4\u540E\uFF0C\u4F1A\u5C06\u76F8\u5E94\u7684\u5E93\u5B58\u4ECEerp\u4E2D\u6263\u9664\u3002",theme:"success",onConfirm:m=>G(r)},{default:u(()=>[t(_,{size:"small",theme:"success",variant:"text"},{default:u(()=>[E("\u540C\u6B65erp")]),_:1})]),_:2},1032,["onConfirm"])):W("v-if",!0),t(O,{content:"\u786E\u8BA4\u5220\u9664\u8BE5\u8BA2\u5355\u5417\uFF1F\u5220\u9664\u540E\u4E0D\u53EF\u6062\u590D",theme:"danger",onConfirm:m=>$(r)},{default:u(()=>[t(_,{size:"small",theme:"danger",variant:"text"},{default:u(()=>[E("\u5220\u9664")]),_:1})]),_:2},1032,["onConfirm"])]),_:1},8,["data","loading"]),t(T,{modelValue:F.value,"onUpdate:modelValue":c[3]||(c[3]=r=>F.value=r),pageSize:D.value,"onUpdate:pageSize":c[4]||(c[4]=r=>D.value=r),"page-size-options":B,total:g.value,class:"pagination",onChange:R},null,8,["modelValue","pageSize","total"])])]),_:1}),t(ie,{ref_key:"editSaleOrderDialog",ref:x,onOnOrderChange:c[5]||(c[5]=r=>w())},null,512)])}}});var Te=ue(Ve,[["__scopeId","data-v-135960ee"],["__file","/Users/jkguo/workspace/ec-erp-static/src/pages/sales/saleOrderList.vue"]]);export{Te as default};
