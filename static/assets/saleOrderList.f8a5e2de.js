import{i as U,r as f,M as v,_ as Z,d as ee,n as oe,a as _,b,c as ue,h as V,w as u,e as t,u as I,g as E,f as K,t as w,j as H,k as W,p as te,q as ae,o as se}from"./index.d52f08ed.js";import{s as re}from"./warehouseApis.c9f35dfd.js";import{a as ie,s as ce,b as X,l as _e}from"./skuUtil.4a31af0a.js";import"./supplierApis.13a2c7c9.js";const de=a=>U.post("/erp_api/sale/save_sku_sale_price",a),pe=a=>U.post("/erp_api/sale/search_sku_sale_price",a),ge=a=>U.post("/erp_api/sale/create_sale_order",a),me=a=>U.post("/erp_api/sale/update_sale_order",a),ke=a=>U.post("/erp_api/sale/delete_sale_order",a),fe=a=>U.post("/erp_api/sale/submit_sale_order",a),ve=a=>U.post("/erp_api/sale/search_sale_order",a),T=f(new Map);async function Ee(){T.value=new Map;const a=1e4;let i=1,n=!0;try{for(;n;){const o=await re({current_page:i,page_size:a,search_sku:""});o.list&&o.list.length>0&&o.list.forEach(p=>{T.value.set(p.sku,p)}),n=o.list&&o.list.length===a,i++}console.log(`\u6210\u529F\u52A0\u8F7D ${T.value.size} \u6761SKU\u62E3\u8D27\u5907\u6CE8\u4FE1\u606F`)}catch(s){console.error("\u52A0\u8F7DSKU\u62E3\u8D27\u5907\u6CE8\u5931\u8D25:",s),await v.error(`\u52A0\u8F7DSKU\u62E3\u8D27\u5907\u6CE8\u5F02\u5E38: ${s}`)}}function J(a,i){const n=T.value.get(a);if(!n)return{picking_count:i,picking_unit:"pcs",display_text:`${i} pcs`};if(n.support_pkg_picking&&n.pkg_picking_unit>0){const o=Math.floor(i/n.pkg_picking_unit),p=i%n.pkg_picking_unit;if(p===0)return{picking_count:o,picking_unit:n.pkg_picking_unit_name,display_text:`${o} ${n.pkg_picking_unit_name}`};if(o>0)return{picking_count:o,picking_unit:n.pkg_picking_unit_name,display_text:`${o} ${n.pkg_picking_unit_name} + ${p} ${n.picking_unit_name}`}}const s=i/n.picking_unit;return{picking_count:s,picking_unit:n.picking_unit_name,display_text:`${s} ${n.picking_unit_name}`}}function ye(a){if(!a||a.length===0)return"-";const i=new Map;a.forEach(s=>{const o=s.sku_group||"\u672A\u5206\u7EC4",p=s.quantity||0,h=s.total_amount||(s.unit_price||0)*p;if(i.has(o)){const y=i.get(o);i.set(o,{totalQuantity:y.totalQuantity+p,totalAmount:y.totalAmount+h,firstSku:y.firstSku})}else i.set(o,{totalQuantity:p,totalAmount:h,firstSku:s.sku})});const n=[];return i.forEach((s,o)=>{const p=J(s.firstSku,s.totalQuantity);n.push(`${o}: ${p.display_text} = ${s.totalAmount.toFixed(2)}`)}),n.join(`
`)}const z=f(new Map);async function Fe(){z.value=new Map;const a=1e4;let i=1,n=!0;try{for(;n;){const o=await pe({current_page:i,page_size:a,sku:""});o.records&&o.records.length>0&&o.records.forEach(p=>{z.value.set(p.sku,p.unit_price)}),n=o.records&&o.records.length===a,i++}console.log(`\u6210\u529F\u52A0\u8F7D ${z.value.size} \u6761SKU\u9500\u552E\u4EF7\u683C\u4FE1\u606F`)}catch(s){console.error("\u52A0\u8F7DSKU\u9500\u552E\u4EF7\u683C\u5931\u8D25:",s),await v.error(`\u52A0\u8F7DSKU\u9500\u552E\u4EF7\u683C\u5F02\u5E38: ${s}`)}}function he(a){return z.value.get(a)||0}async function Be(a){const i=[];for(const n of a){const s=z.value.get(n.sku),o=n.unit_price;(s===void 0||s!==o)&&(i.push(de({sku:n.sku,unit_price:o})),z.value.set(n.sku,o))}i.length>0&&(await Promise.all(i),console.log(`\u6210\u529F\u66F4\u65B0 ${i.length} \u6761SKU\u9500\u552E\u4EF7\u683C`))}const ne=a=>(te("data-v-ec2d381a"),a=a(),ae(),a),De={style:{"text-align":"right"}},we=ne(()=>K("br",null,null,-1)),Se={class:"table-container"},Ce=ne(()=>K("br",null,null,-1)),Ae={name:"EditSaleOrderDialog"},be=ee({...Ae,emits:["onOrderChange"],setup(a,{expose:i,emit:n}){const s=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}),o=f(!1),p=f(!0),h=f(null),y=f(""),D=f(""),B=f(""),g=f([]),x=f(0),S=oe(()=>{if(!D.value)return[];const l=ie.value.get(D.value);return l?l.map(e=>({label:`${e.sku} - ${e.sku_name}`,value:e.sku})):[]}),R=[{width:100,colKey:"sku_group",title:"SKU\u5206\u7EC4",align:"center"},{width:120,colKey:"sku_name",title:"\u5546\u54C1\u540D",align:"center"},{width:150,colKey:"sku",title:"\u5546\u54C1SKU",align:"center"},{width:100,colKey:"quantity",title:"\u6570\u91CF",align:"center",edit:{component:W,props:{autofocus:!0,min:1},validateTrigger:"change",abortEditOnEvent:["onEnter","onBlur"],onEdited:l=>{g.value.splice(l.rowIndex,1,l.newRowData),N(l.rowIndex),$()},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!0}},{width:150,colKey:"picking_info",title:"\u62E3\u8D27\u4FE1\u606F",align:"center"},{width:100,colKey:"unit_price",title:"\u5355\u4EF7",align:"center",edit:{component:W,props:{autofocus:!0,min:.01,step:.01},validateTrigger:"change",abortEditOnEvent:["onEnter","onBlur"],onEdited:l=>{g.value.splice(l.rowIndex,1,l.newRowData),$()},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!1}},{width:120,colKey:"total_amount",title:"\u603B\u4EF7",align:"center"},{width:80,colKey:"operation",title:"\u64CD\u4F5C",align:"center"}],N=l=>{const e=g.value[l],c=J(e.sku,e.quantity);e.picking_display_text=c.display_text,e.total_amount=e.unit_price*e.quantity},L=()=>{if(!B.value){v.warning("\u8BF7\u5148\u9009\u62E9SKU");return}if(g.value.find(C=>C.sku===B.value)){v.warning("\u8BE5SKU\u5DF2\u6DFB\u52A0");return}const e=X.value.get(B.value);if(!e){v.error("SKU\u4FE1\u606F\u4E0D\u5B58\u5728");return}const c=he(B.value),k={idx:g.value.length+1,sku:e.sku,sku_group:e.sku_group,sku_name:e.sku_name,erp_sku_image_url:e.erp_sku_image_url,quantity:1,unit_price:c||0,total_amount:c||0,picking_display_text:""};g.value.push(k),N(g.value.length-1),$(),B.value=""},j=l=>{const e=g.value.findIndex(c=>c.idx===l.idx);e!==-1&&(g.value.splice(e,1),g.value.forEach((c,k)=>{c.idx=k+1}),$())},$=()=>{x.value=0,g.value.forEach(l=>{l.total_amount=l.quantity*l.unit_price,x.value+=l.total_amount})},F=async l=>{await _e(),await Fe(),l?(p.value=!1,h.value=l,y.value=l.order_date,g.value=[],l.sale_sku_list.forEach((e,c)=>{const k=X.value.get(e.sku),C=J(e.sku,e.quantity);g.value.push({idx:c+1,sku:e.sku,sku_group:e.sku_group||(k==null?void 0:k.sku_group)||"",sku_name:e.sku_name||(k==null?void 0:k.sku_name)||"",erp_sku_image_url:e.erp_sku_image_url||(k==null?void 0:k.erp_sku_image_url)||"",quantity:e.quantity,unit_price:e.unit_price,total_amount:e.total_amount||e.unit_price*e.quantity,picking_display_text:C.display_text})})):(p.value=!0,h.value=null,y.value=new Date().toISOString().slice(0,10),g.value=[]),D.value="",B.value="",$(),o.value=!0},d=()=>g.value.map(l=>({sku:l.sku,sku_group:l.sku_group,sku_name:l.sku_name,erp_sku_image_url:l.erp_sku_image_url,quantity:l.quantity,unit_price:l.unit_price,total_amount:l.total_amount})),M=async()=>{if(!y.value){v.error("\u8BF7\u9009\u62E9\u8BA2\u5355\u65E5\u671F");return}if(g.value.length===0){v.error("\u8BF7\u81F3\u5C11\u6DFB\u52A0\u4E00\u4E2A\u5546\u54C1");return}if(g.value.filter(e=>!e.unit_price||e.unit_price<=0).length>0){v.error("\u5B58\u5728\u672A\u8BBE\u7F6E\u5355\u4EF7\u7684\u5546\u54C1\uFF0C\u8BF7\u68C0\u67E5");return}try{await Be(g.value);const e=d();if(p.value){const c={order_date:y.value,sale_sku_list:e};console.log("\u521B\u5EFA\u9500\u552E\u8BA2\u5355:",c),await ge(c),v.success("\u521B\u5EFA\u9500\u552E\u8BA2\u5355\u6210\u529F")}else{const c={order_id:h.value.order_id,order_date:y.value,sale_sku_list:e};console.log("\u66F4\u65B0\u9500\u552E\u8BA2\u5355:",c),await me(c),v.success("\u66F4\u65B0\u9500\u552E\u8BA2\u5355\u6210\u529F")}o.value=!1,n("onOrderChange")}catch(e){console.error("\u4FDD\u5B58\u9500\u552E\u8BA2\u5355\u5931\u8D25:",e),v.error(`\u4FDD\u5B58\u9500\u552E\u8BA2\u5355\u5F02\u5E38: ${e}`)}};return i({popupDialog:F}),(l,e)=>{const c=_("t-date-picker"),k=_("t-form-item"),C=_("t-form"),A=_("t-col"),q=_("t-row"),P=_("t-select"),O=_("t-button"),G=_("t-image"),Y=_("t-space"),Q=_("t-table"),r=_("t-dialog");return b(),ue("div",null,[o.value?(b(),V(r,{key:0,visible:o.value,"onUpdate:visible":e[4]||(e[4]=m=>o.value=m),"cancel-btn":null,"close-on-esc-keydown":!1,"close-on-overlay-click":!1,"confirm-btn":null,header:p.value?"\u65B0\u5EFA\u9500\u552E\u8BA2\u5355":"\u7F16\u8F91\u9500\u552E\u8BA2\u5355","show-overlay":"",width:"85%"},{default:u(()=>[t(q,null,{default:u(()=>[t(A,{span:10},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(k,{label:"\u8BA2\u5355\u65E5\u671F:",name:"orderDate",required:""},{default:u(()=>[t(c,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=m=>y.value=m),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u9009\u62E9\u8BA2\u5355\u65E5\u671F",style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(q,null,{default:u(()=>[t(A,{span:8},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(k,{label:"SKU\u5206\u7EC4:",name:"skuGroupName"},{default:u(()=>[t(P,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=m=>D.value=m),options:I(ce),filterable:"",placeholder:"-\u8BF7\u9009\u62E9SKU\u5206\u7EC4-",style:{width:"200px"}},null,8,["modelValue","options"])]),_:1}),t(k,{label:"SKU:",name:"selectedSku"},{default:u(()=>[t(P,{modelValue:B.value,"onUpdate:modelValue":e[2]||(e[2]=m=>B.value=m),options:I(S),filterable:"",placeholder:"-\u8BF7\u9009\u62E9SKU-",style:{width:"250px"}},null,8,["modelValue","options"])]),_:1})]),_:1})]),_:1}),t(A,{span:3},{default:u(()=>[t(O,{theme:"default",onClick:L},{default:u(()=>[E("\u6DFB\u52A0SKU")]),_:1})]),_:1}),t(A,{span:7},{default:u(()=>[K("h3",De,"\u603B\u91D1\u989D\uFF1A"+w(I(s).format(x.value)),1)]),_:1})]),_:1}),we,K("div",Se,[t(Q,{bordered:!0,columns:R,data:g.value,"lazy-load":"",resizable:"","row-key":"idx","table-layout":"fixed"},{sku:u(({row:m})=>[t(Y,null,{default:u(()=>[t(G,{src:m.erp_sku_image_url,style:{width:"30px",height:"30px"}},null,8,["src"]),E(" "+w(m.sku),1)]),_:2},1024)]),picking_info:u(({row:m})=>[E(w(m.picking_display_text),1)]),total_amount:u(({row:m})=>[E(w(I(s).format(m.total_amount)),1)]),operation:u(({row:m})=>[t(O,{size:"small",theme:"danger",variant:"text",onClick:Pe=>j(m)},{default:u(()=>[E("\u5220\u9664")]),_:2},1032,["onClick"])]),_:1},8,["data"]),Ce,t(q,null,{default:u(()=>[t(A,{span:9}),t(A,{span:3},{default:u(()=>[t(Y,null,{default:u(()=>[t(O,{style:{float:"right"},theme:"default",onClick:e[3]||(e[3]=m=>o.value=!1)},{default:u(()=>[E("\u53D6\u6D88")]),_:1}),t(O,{style:{float:"right"},theme:"primary",onClick:M},{default:u(()=>[E("\u4FDD\u5B58")]),_:1})]),_:1})]),_:1})]),_:1})])]),_:1},8,["visible","header"])):H("v-if",!0)])}}});var le=Z(be,[["__scopeId","data-v-ec2d381a"],["__file","/Users/jkguo/workspace/ec-erp-static/src/pages/sales/components/editSaleOrderDialog.vue"]]);const xe=a=>(te("data-v-135960ee"),a=a(),ae(),a),$e=xe(()=>K("br",null,null,-1)),Oe={class:"table-container"},Ke={style:{"white-space":"pre-wrap"}},Ue={name:"SaleOrderList",components:{EditSaleOrderDialog:le}},Me=ee({...Ue,setup(a){const i=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}),n=f({status:"",begin_date:"",end_date:""}),s=[{label:"\u5F85\u540C\u6B65",value:"\u5F85\u540C\u6B65"},{label:"\u5DF2\u540C\u6B65",value:"\u5DF2\u540C\u6B65"}],o=[{width:80,colKey:"order_id",title:"\u8BA2\u5355ID",align:"center"},{width:150,colKey:"order_date",title:"\u8BA2\u5355\u65E5\u671F",align:"center"},{width:250,colKey:"sku_order_summary",title:"\u8BA2\u5355\u6458\u8981",align:"left"},{width:120,colKey:"total_amount",title:"\u603B\u91D1\u989D",align:"center"},{width:100,colKey:"status",title:"\u72B6\u6001",align:"center"},{width:150,colKey:"modify_time",title:"\u4FEE\u6539\u65F6\u95F4",align:"center"},{width:180,colKey:"op",title:"\u64CD\u4F5C",align:"center",fixed:"right"}],p=f([]),h=f(!1),y=f(1),D=f(20),B=[10,20,50,100],g=f(0),x=f(),S=async()=>{h.value=!0;try{const F={status:n.value.status||void 0,begin_date:n.value.begin_date||void 0,end_date:n.value.end_date||void 0,current_page:y.value,page_size:D.value},d=await ve(F);p.value=d.records.map(M=>({...M,sku_order_summary:ye(M.sale_sku_list)})),g.value=d.total}catch(F){console.error("\u67E5\u8BE2\u9500\u552E\u8BA2\u5355\u5931\u8D25:",F),v.error(`\u67E5\u8BE2\u9500\u552E\u8BA2\u5355\u5F02\u5E38: ${F}`)}finally{h.value=!1}},R=()=>{S()},N=()=>{x.value.popupDialog(null)},L=F=>{x.value.popupDialog(F)},j=async F=>{try{await fe({order_id:F.order_id}),v.success("\u63D0\u4EA4\u8BA2\u5355\u6210\u529F"),await S()}catch(d){console.error("\u63D0\u4EA4\u8BA2\u5355\u5931\u8D25:",d),v.error(`\u63D0\u4EA4\u8BA2\u5355\u5F02\u5E38: ${d}`)}},$=async F=>{try{await ke({order_id:F.order_id}),v.success("\u5220\u9664\u8BA2\u5355\u6210\u529F"),await S()}catch(d){console.error("\u5220\u9664\u8BA2\u5355\u5931\u8D25:",d),v.error(`\u5220\u9664\u8BA2\u5355\u5F02\u5E38: ${d}`)}};return se(async()=>{await Ee(),await S()}),(F,d)=>{const M=_("t-select"),l=_("t-form-item"),e=_("t-date-picker"),c=_("t-button"),k=_("t-space"),C=_("t-form"),A=_("t-col"),q=_("t-row"),P=_("t-tag"),O=_("t-popconfirm"),G=_("t-table"),Y=_("t-pagination"),Q=_("t-card");return b(),ue("div",null,[t(Q,null,{default:u(()=>[t(q,null,{default:u(()=>[t(A,{span:12},{default:u(()=>[t(C,{layout:"inline"},{default:u(()=>[t(l,{label:"\u8BA2\u5355\u72B6\u6001:",name:"status"},{default:u(()=>[t(M,{modelValue:n.value.status,"onUpdate:modelValue":d[0]||(d[0]=r=>n.value.status=r),options:s,clearable:"",placeholder:"\u8BF7\u9009\u62E9\u72B6\u6001",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(l,{label:"\u5F00\u59CB\u65E5\u671F:",name:"begin_date"},{default:u(()=>[t(e,{modelValue:n.value.begin_date,"onUpdate:modelValue":d[1]||(d[1]=r=>n.value.begin_date=r),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u5F00\u59CB\u65E5\u671F",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(l,{label:"\u7ED3\u675F\u65E5\u671F:",name:"end_date"},{default:u(()=>[t(e,{modelValue:n.value.end_date,"onUpdate:modelValue":d[2]||(d[2]=r=>n.value.end_date=r),"allow-input":"",clearable:"",format:"YYYY-MM-DD",placeholder:"\u7ED3\u675F\u65E5\u671F",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(l,null,{default:u(()=>[t(k,{size:"small",style:{"align-items":"center","margin-left":"30px"}},{default:u(()=>[t(c,{theme:"primary",onClick:S},{default:u(()=>[E("\u67E5\u8BE2")]),_:1}),t(c,{theme:"success",onClick:N},{default:u(()=>[E("\u65B0\u5EFA\u8BA2\u5355")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),$e,K("div",Oe,[t(G,{columns:o,data:p.value,loading:h.value,bordered:"",hover:"","row-key":"order_id",stripe:""},{sku_order_summary:u(({row:r})=>[K("div",Ke,w(r.sku_order_summary),1)]),total_amount:u(({row:r})=>[E(w(I(i).format(r.total_amount)),1)]),status:u(({row:r})=>[r.status==="\u5F85\u540C\u6B65"?(b(),V(P,{key:0,theme:"warning"},{default:u(()=>[E(w(r.status),1)]),_:2},1024)):r.status==="\u5DF2\u540C\u6B65"?(b(),V(P,{key:1,theme:"success"},{default:u(()=>[E(w(r.status),1)]),_:2},1024)):(b(),V(P,{key:2},{default:u(()=>[E(w(r.status),1)]),_:2},1024))]),op:u(({row:r})=>[r.status==="\u5F85\u540C\u6B65"?(b(),V(c,{key:0,size:"small",theme:"primary",variant:"text",onClick:m=>L(r)},{default:u(()=>[E(" \u7F16\u8F91 ")]),_:2},1032,["onClick"])):H("v-if",!0),r.status==="\u5F85\u540C\u6B65"?(b(),V(O,{key:1,content:"\u786E\u8BA4\u63D0\u4EA4\u8BE5\u8BA2\u5355\u5417\uFF1F\u63D0\u4EA4\u540E\u8BA2\u5355\u72B6\u6001\u5C06\u53D8\u4E3A\u300C\u5DF2\u540C\u6B65\u300D",theme:"success",onConfirm:m=>j(r)},{default:u(()=>[t(c,{size:"small",theme:"success",variant:"text"},{default:u(()=>[E("\u63D0\u4EA4")]),_:1})]),_:2},1032,["onConfirm"])):H("v-if",!0),t(O,{content:"\u786E\u8BA4\u5220\u9664\u8BE5\u8BA2\u5355\u5417\uFF1F\u5220\u9664\u540E\u4E0D\u53EF\u6062\u590D",theme:"danger",onConfirm:m=>$(r)},{default:u(()=>[t(c,{size:"small",theme:"danger",variant:"text"},{default:u(()=>[E("\u5220\u9664")]),_:1})]),_:2},1032,["onConfirm"])]),_:1},8,["data","loading"]),t(Y,{modelValue:y.value,"onUpdate:modelValue":d[3]||(d[3]=r=>y.value=r),pageSize:D.value,"onUpdate:pageSize":d[4]||(d[4]=r=>D.value=r),"page-size-options":B,total:g.value,class:"pagination",onChange:R},null,8,["modelValue","pageSize","total"])])]),_:1}),t(le,{ref_key:"editSaleOrderDialog",ref:x,onOnOrderChange:d[5]||(d[5]=r=>S())},null,512)])}}});var Ne=Z(Me,[["__scopeId","data-v-135960ee"],["__file","/Users/jkguo/workspace/ec-erp-static/src/pages/sales/saleOrderList.vue"]]);export{Ne as default};
